# STM32 Sequencer

Полнофункциональный секвенсор для STM32F4 с 4 барабанными дорожками и 2 пианино-дорожками.

## Возможности

- **6 дорожек**: 4 барабанные + 2 пианино
- **Динамические блоки**: до 16 блоков по 4 такта на дорожку
- **Режимы работы**: Play/Stop, Edit, Settings
- **UART протокол**: сохранение/загрузка проектов
- **Python инструменты**: для работы с устройством

## Управление

### Клавиши (12 кнопок)
```
Ряд 1: [1] [2] [3] [4]     - Барабаны/Ноты
Ряд 2: [A] [B] [OK] [Back] - Save/Load/Select/Back
Ряд 3: [↑] [↓] [←] [→]    - Навигация
```

### Режимы работы

1. **Splash Screen** - начальная заставка (2 сек)
2. **Main Menu** - главное меню
   - 1-4: выбор дорожки для редактирования
   - A: сохранение проекта
   - B: загрузка проекта
   - OK: Play/Stop
   - Back: настройки

3. **Edit Mode** - редактирование
   - 1-4: установка/снятие барабана или ноты
   - Стрелки: навигация по дорожкам и тактам
   - Back: возврат в главное меню

4. **Settings Mode** - настройки
   - Up/Down: изменение BPM
   - Left/Right: изменение громкости
   - Back: возврат в главное меню

## Структура проекта

### C++ компоненты
- `Sequencer.hpp/cpp` - основные структуры данных
- `SequencerUI.hpp/cpp` - система меню и отрисовка
- `Images.hpp/cpp` - изображения для дисплея
- `AppTasks.cpp` - интеграция с планировщиком

### Python инструменты
- `sequencer_tool.py` - работа с устройством через UART
- `image_converter.py` - конвертация изображений

## Использование

### Сборка проекта
```bash
# В STM32CubeIDE или аналогичной среде
# Проект уже настроен для компиляции
```

### Работа с Python инструментами

#### Конвертация изображений
```bash
# Создать примеры изображений
python image_converter.py --create-samples

# Конвертировать изображение
python image_converter.py splash.png -o splash_image.h -n splash_data
```

#### Работа с секвенсором
```bash
# Сохранение проекта
python sequencer_tool.py COM3 save my_project.seq

# Загрузка проекта
python sequencer_tool.py COM3 load my_project.seq

# Мониторинг устройства
python sequencer_tool.py COM3 monitor

# Получение статуса
python sequencer_tool.py COM3 status
```

## Формат данных

### Структура проекта
- **BPM**: 60-240
- **Volume**: 0-10
- **Tracks**: 6 дорожек (4 барабана + 2 пианино)
- **Blocks**: до 16 блоков на дорожку
- **Beats**: 4 такта в блоке

### UART протокол
```
SAVE<CR><LF>
PROJECT_START
BPM,120
VOLUME,8
TRACK,0,DRUM,KICK
BLOCK,0,1,0,1,0
TRACK,4,PIANO
BLOCK,0,0,255,4,255
PROJECT_END<CR><LF>
```

## Технические детали

- **Дисплей**: 128x64 OLED
- **Память**: ~1KB на проект
- **BPM**: 60-240 (250ms минимальный такт)
- **Полифония**: 8 голосов
- **Дорожки**: 4 барабана + 2 пианино

## Разработка

### Добавление новых функций
1. Обновите структуры данных в `Sequencer.hpp`
2. Добавьте UI в `SequencerUI.hpp`
3. Обновите обработку клавиш в `AppTasks.cpp`
4. Протестируйте через UART

### Отладка
- Используйте UART мониторинг для отладки
- Проверяйте статус через `sequencer_tool.py`
- Логи выводятся в UART консоль
