# –ê–ì–†–ï–°–°–ò–í–ù–´–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã "–≥—É–¥–∏—Ç –Ω–∞ –æ–¥–Ω–æ–π —á–∞—Å—Ç–æ—Ç–µ"

## –ü—Ä–æ–±–ª–µ–º–∞
–°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä –≤—Å–µ –µ—â–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–ª —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É —á–∞—Å—Ç–æ—Ç—É –∏ –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–ª—Å—è –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –Ω–æ—Ç–∞–º–∏.

## –ê–ì–†–ï–°–°–ò–í–ù–´–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. **–ê–ì–†–ï–°–°–ò–í–ù–ê–Ø –æ—á–∏—Å—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤ –ø—Ä–∏ –Ω–æ–≤–æ–π –Ω–æ—Ç–µ**
```cpp
// –ê–ì–†–ï–°–°–ò–í–ù–û: –û—Ç–∫–ª—é—á–∞–µ–º –í–°–ï —Å—Ç–∞—Ä—ã–µ –≥–æ–ª–æ—Å–∞ –ø—Ä–∏ –Ω–æ–≤–æ–π –Ω–æ—Ç–µ
for (uint8_t i = 0; i < MAX_VOICES; i++) {
    if (voices[i].active) {
        voices[i].active = false;
        Uart::getInstance().printf("Stopping old voice %d for new note\n", i);
    }
}
```

### 2. **–ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Buzzer**
```cpp
// –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –æ–±–Ω–æ–≤–ª—è–µ–º Buzzer —Å—Ä–∞–∑—É
Buzzer::getInstance().playNote(0, voice.frequency, voice.velocity);
Uart::getInstance().printf("FORCED Buzzer update: freq=%d, vol=%d\n", voice.frequency, voice.velocity);
```

### 3. **–ê–ì–†–ï–°–°–ò–í–ù–û–ï –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –≥–æ–ª–æ—Å–æ–≤**
```cpp
// –ê–ì–†–ï–°–°–ò–í–ù–û: –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–µ –≥–æ–ª–æ—Å–∞ (—Å—Ç–∞—Ä—à–µ 500–º—Å)
for (uint8_t i = 0; i < MAX_VOICES; i++) {
    if (voices[i].active && (currentTime - voices[i].startTime) > 500) {
        voices[i].active = false;
    }
}
```

### 4. **–£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –º–∏–∫—à–∏—Ä–æ–≤–∞–Ω–∏–µ**
```cpp
// –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –º–∏–∫—à–∏—Ä–æ–≤–∞–Ω–∏–µ - –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π –≥–æ–ª–æ—Å
for (uint8_t i = 0; i < MAX_VOICES; i++) {
    if (voices[i].active) {
        uint8_t volume = calculateVolume(voices[i]);
        if (volume > 0) {
            mixedFreq = voices[i].frequency;
            mixedVolume = volume;
            break; // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π –≥–æ–ª–æ—Å
        }
    }
}
```

### 5. **–ê–ì–†–ï–°–°–ò–í–ù–ê–Ø –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞—Ä–∞–±–∞–Ω–Ω—ã—Ö –∑–≤—É–∫–æ–≤**
```cpp
// –ê–ì–†–ï–°–°–ò–í–ù–û: –û—Ç–∫–ª—é—á–∞–µ–º –í–°–ï –≥–æ–ª–æ—Å–∞ –¥–ª—è –±–∞—Ä–∞–±–∞–Ω–Ω–æ–≥–æ –∑–≤—É–∫–∞
for (uint8_t i = 0; i < MAX_VOICES; i++) {
    if (voices[i].active) {
        voices[i].active = false;
    }
}

// –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –∏–≥—Ä–∞–µ–º –±–∞—Ä–∞–±–∞–Ω–Ω—ã–π –∑–≤—É–∫
Buzzer::getInstance().playNote(0, sound.frequency, sound.volume);
```

## –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

### ‚úÖ **–¢–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å:**
1. **–ö–∞–∂–¥–∞—è –Ω–æ–≤–∞—è –Ω–æ—Ç–∞** - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ—Ç –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –≥–æ–ª–æ—Å–∞
2. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - Buzzer –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø—Ä–∏ –Ω–æ–≤–æ–π –Ω–æ—Ç–µ
3. **–ë—ã—Å—Ç—Ä–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ** - —Å—Ç–∞—Ä—ã–µ –≥–æ–ª–æ—Å–∞ –æ—Ç–∫–ª—é—á–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ 500–º—Å
4. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–æ–≤—ã—Ö –∑–≤—É–∫–æ–≤** - –Ω–æ–≤—ã–µ –Ω–æ—Ç—ã –≤—Å–µ–≥–¥–∞ –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
5. **–û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

### üìä **–û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å:**
```
MIDI: noteOn ch=0, note=60, freq=262, vel=64, voice=0
FORCED Buzzer update: freq=262, vol=64
Stopping old voice 0 for new note
MIDI: noteOn ch=0, note=64, freq=330, vel=64, voice=0
FORCED Buzzer update: freq=330, vol=64
mixVoices: 1 active voices, freq=330, vol=64
Auto-stopping old voice 0 (age=501 ms)
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. **–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ç–µ—Å—Ç**
```bash
python test_aggressive_notes.py
```

### 2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞**
–î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è:
- `MIDI: noteOn ch=X, note=Y, freq=Z, vel=W, voice=V`
- `FORCED Buzzer update: freq=X, vol=Y`
- `Stopping old voice X for new note`
- `mixVoices: X active voices, freq=Y, vol=Z`

### 3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ–Ω—ã —á–∞—Å—Ç–æ—Ç—ã**
–í –æ—Ç–ª–∞–¥–æ—á–Ω–æ–º –≤—ã–≤–æ–¥–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è `freq=` –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –Ω–æ—Ç.

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ "–≥—É–¥–∏—Ç –Ω–∞ –æ–¥–Ω–æ–π —á–∞—Å—Ç–æ—Ç–µ":

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥** - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è `FORCED Buzzer update`
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–º–µ–Ω—É —á–∞—Å—Ç–æ—Ç—ã** - –∑–Ω–∞—á–µ–Ω–∏—è `freq=` –¥–æ–ª–∂–Ω—ã –º–µ–Ω—è—Ç—å—Å—è
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ PWM** - –≤ `Buzzer::updatePWM()` –¥–æ–ª–∂–Ω–∞ –º–µ–Ω—è—Ç—å—Å—è —á–∞—Å—Ç–æ—Ç–∞
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–¥–∞—á–∏** - `SynthesizerTask` –¥–æ–ª–∂–Ω–∞ –≤—ã–∑—ã–≤–∞—Ç—å `update()`

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
- **–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π `FORCED Buzzer update`** - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `noteOn()`
- **–ß–∞—Å—Ç–æ—Ç–∞ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –≤ PWM** - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `updatePWM()`
- **–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –æ —Å–º–µ–Ω–µ –≥–æ–ª–æ—Å–æ–≤** - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `mixVoices()`
- **–ë–∞—Ä–∞–±–∞–Ω—ã –º–µ—à–∞—é—Ç** - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `generateDrumSound()`

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤—Å–µ –µ—â–µ –µ—Å—Ç—å:
1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** - buzzer –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ TIM1_CH1
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–π–º–µ—Ä–∞** - –≤ `tim.h` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–∫—Ç–æ–≤—É—é —á–∞—Å—Ç–æ—Ç—É** - PCLK –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–¥–∞—á–∏** - –≤—Å–µ –∑–∞–¥–∞—á–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫

### –î–ª—è –æ—Ç–ª–∞–¥–∫–∏:
1. **–î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞** –≤ `Buzzer::updatePWM()`
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è PSC –∏ ARR** –≤ —Ç–∞–π–º–µ—Ä–µ
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ duty cycle** –≤ `TIM1->CCR1`
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** buzzer –∫ –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—É
