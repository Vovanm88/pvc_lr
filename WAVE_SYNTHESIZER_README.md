# Синтезатор с микшированием волн

## Обзор

Новый синтезатор реализует настоящий синтез звука с микшированием волн, как в профессиональных синтезаторах. Вместо простого выбора самого громкого голоса, система генерирует и смешивает аудиосигналы.

## Архитектура

### Основные компоненты:

1. **WaveGenerator** - генерация различных типов волн
2. **VoiceMixer** - микширование голосов и применение ADSR
3. **WaveSynthesizer** - основной класс синтезатора

### Типы волн:

- **SINE** - синусоида (чистый тон)
- **SQUARE** - прямоугольная волна (богатые гармоники)
- **SAWTOOTH** - пилообразная волна (яркий звук)
- **TRIANGLE** - треугольная волна (мягкий звук)
- **NOISE** - белый шум (перкуссия)

## Особенности

### 1. Генерация волн
```cpp
// Синусоида
float sample = sin(phase);

// Прямоугольная волна
float sample = (sin(phase) >= 0) ? 1.0f : -1.0f;

// Пилообразная волна
float sample = 2.0f * (phase / (2π)) - 1.0f;
```

### 2. Гармоники
Система добавляет гармоники для более богатого звука:
```cpp
float sample = 0;
for (int i = 1; i <= harmonics; i++) {
    sample += (amplitude / i) * sin(phase * i);
}
```

### 3. Микширование
Все активные голоса смешиваются:
```cpp
float mixedSample = 0;
for (each active voice) {
    mixedSample += voiceSample * adsrVolume;
}
mixedSample /= activeVoices; // Нормализация
```

### 4. ADSR Envelope
- **Attack**: плавное нарастание
- **Decay**: плавный спад до sustain уровня
- **Sustain**: поддержка ноты
- **Release**: плавное затухание

## Использование

### Инициализация:
```cpp
WaveSynthesizer& synth = WaveSynthesizer::getInstance();
synth.init();
```

### Игра нот:
```cpp
// Включение ноты
synth.noteOn(0, 60, 80);  // канал, нота, громкость

// Смена типа волны
synth.setWaveType(0, WaveType::SQUARE);

// Выключение ноты
synth.noteOff(0, 60);
```

### Генерация аудио:
```cpp
float sample = synth.generateSample();
// sample содержит микшированный аудиосигнал
```

## Тестирование

Запустите тесты для проверки:

```bash
python test_wave_synthesizer.py
```

### Тесты включают:

1. **Тест типов волн** - проверка всех типов волн
2. **Тест полифонии** - несколько нот с разными волнами
3. **Генерация образцов** - визуализация волн

## Преимущества над старым синтезатором

### Старый синтезатор:
- ❌ Только один голос воспроизводился
- ❌ Простое переключение между голосами
- ❌ Нет настоящего микширования
- ❌ Ограниченные возможности синтеза

### Новый синтезатор:
- ✅ Настоящее микширование волн
- ✅ Различные типы волн
- ✅ Гармоники для богатого звука
- ✅ Профессиональный ADSR envelope
- ✅ Полифония с микшированием

## Технические детали

### Частота дискретизации:
- **SAMPLE_RATE**: 44100 Hz (CD качество)

### Полифония:
- **MAX_VOICES**: 8 голосов
- **MAX_CHANNELS**: 16 MIDI каналов

### Гармоники:
- **MAX_HARMONICS**: 8 гармоник
- Убывающая амплитуда: 1/n

### ADSR по умолчанию:
- **Attack**: 50мс
- **Decay**: 100мс  
- **Sustain**: 7/10
- **Release**: 200мс

## Интеграция

Новый синтезатор находится в отдельной папке:
```
Core/Inc/synthesizer/
Core/Src/synthesizer/
```

Это позволяет:
- Не нарушать существующий код
- Легко переключаться между синтезаторами
- Независимо тестировать новую функциональность

## Будущие улучшения

1. **Фильтры** - низкочастотные, высокочастотные, полосовые
2. **Эффекты** - реверб, хорус, дисторшн
3. **LFO** - низкочастотные осцилляторы для модуляции
4. **Семплы** - загрузка и воспроизведение семплов
5. **MIDI контроллеры** - управление параметрами в реальном времени

